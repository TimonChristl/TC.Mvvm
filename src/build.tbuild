<?xml version="1.0" encoding="utf-8" ?>
<Script xmlns="urn:TBuild"
        xmlns:core="urn:TBuild.Plugin.Core"
        xmlns:msbuild="urn:TBuild.Plugin.MsBuild"
        xmlns:fs="urn:TBuild.Plugin.Filesystem"
        MinRequiredVersion="1.9.9.0">
    <Properties>
        <Property Name="Version" Value="0.2.2"/>
    </Properties>
    <Steps>
        <fs:ReadTextFile Filename="${TBuild.ScriptDir}\CommonAssemblyInfo.cs.in" Property="Temp"/>
        <core:RegexSearchAndReplace Property="Temp" Pattern="@VERSION@" Replacement="${Version}.${ENV:BUILD_NUMBER}" />
        <fs:WriteTextFile Filename="${TBuild.ScriptDir}\CommonAssemblyInfo.cs" Property="${Temp}"/>

        <msbuild:MsBuild ProjectFile="${TBuild.ScriptDir}\TC.Mvvm.sln" Configuration="Release" Platform="Any CPU" Targets="Build"/>

        <fs:ReadTextFile Filename="${TBuild.ScriptDir}\TC.Mvvm.nuspec.in" Property="Temp"/>
        <core:RegexSearchAndReplace Property="Temp" Pattern="@VERSION@" Replacement="${Version}" />
        <fs:WriteTextFile Filename="${TBuild.ScriptDir}\TC.Mvvm.nuspec" Property="${Temp}"/>

        <fs:ReadTextFile Filename="${TBuild.ScriptDir}\TC.Mvvm.Sources.nuspec.in" Property="Temp"/>
        <core:RegexSearchAndReplace Property="Temp" Pattern="@VERSION@" Replacement="${Version}" />
        <fs:WriteTextFile Filename="${TBuild.ScriptDir}\TC.Mvvm.Sources.nuspec" Property="${Temp}"/>

        <fs:ReadTextFile Filename="${TBuild.ScriptDir}\TC.Mvvm.Injector.nuspec.in" Property="Temp"/>
        <core:RegexSearchAndReplace Property="Temp" Pattern="@VERSION@" Replacement="${Version}" />
        <fs:WriteTextFile Filename="${TBuild.ScriptDir}\TC.Mvvm.Injector.nuspec" Property="${Temp}"/>

        <core:Exec Filename="${Exe.NuGet}"
                   Arguments="pack ${TBuild.ScriptDir}\TC.Mvvm.nuspec"
                   WorkingDirectory="${TBuild.ScriptDir}"
                   UseShellExecute="false"
                   />

        <core:Exec Filename="${Exe.NuGet}"
                   Arguments="pack -Properties packageid=TC.Mvvm.Sources;packageversion=${Version} ${TBuild.ScriptDir}\TC.Mvvm.Sources.nuspec"
                   WorkingDirectory="${TBuild.ScriptDir}"
                   UseShellExecute="false"
                   />

        <core:Exec Filename="${Exe.NuGet}"
                   Arguments="pack ${TBuild.ScriptDir}\TC.Mvvm.Injector.nuspec"
                   WorkingDirectory="${TBuild.ScriptDir}"
                   UseShellExecute="false"
                   />
    </Steps>
</Script>
